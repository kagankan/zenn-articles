---
title: "Jestã‹ã‚‰Vitestã«ç§»è¡Œã—ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒåŠæ¸›ã—ãŸè©±"
emoji: "ðŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["jest", "vitest", "test"]
published: false
publication_name: "kikagaku"
---

ä»¥å‰å¼Šç¤¾ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒé•·ãã€é–‹ç™ºåŠ¹çŽ‡ã‚’ä¸‹ã’ã¦ã„ã¾ã—ãŸã€‚
ãã“ã§ã€Jest ã‹ã‚‰ Vitest ã«ç§»è¡Œã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã‚’åŠæ¸›ã•ã›ãŸéš›ã®è©±ã‚’ã—ã¾ã™ã€‚

## å‰æ

- NestJS ã‚’ä½¿ç”¨ã—ãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°ã¯ã€DBã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆãŒ700ä»¶ã€ãã†ã§ãªã„å˜ä½“ãƒ†ã‚¹ãƒˆãŒ3000ä»¶ç¨‹åº¦

## å½“æ™‚ã®èª²é¡Œ

- ãƒ†ã‚¹ãƒˆã® CI å®Ÿè¡ŒãŒé…ã„ï¼ï¼ˆDBã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆãŒ700ä»¶ç¨‹åº¦ã®å®Ÿè¡Œã«8åˆ†è¿‘ãã‹ã‹ã£ã¦ã„ãŸï¼‰
    ![ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œãƒ­ã‚°ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€‚7åˆ†48ç§’ã®è¡¨ç¤º](/images/jest-to-vitest/2025-10-28-06-09-13.png)
    
    - ãã®çµæžœã€GitHub Actions ã®èª²é‡‘æž ã‚‚ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã‚³ã‚¹ãƒˆé¢ã®å½±éŸ¿ã‚‚ã‚ã£ãŸ
- ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã‚‚é…ã„ï¼
    - å€‹äººçš„ã«ã¯ã€CIã¯åˆ¥ã«ã„ã„ã‘ã©ãƒ­ãƒ¼ã‚«ãƒ«ãŒé…ã„ã®ãŒã¨ã¦ã‚‚é–‹ç™ºåŠ¹çŽ‡ã‚’ä¸‹ã’ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¦ã„ãŸã€‚é–‹ç™ºä¸­ã®ãƒ†ã‚¹ãƒˆã¯ä½•åå›žä½•ç™¾å›žã¨å®Ÿè¡Œã™ã‚‹ã®ã§ã¡ã‚Šã¤ã‚‚ã€‚

## Vitest ã«å¤‰ãˆã¦ã¿ãŸ

å®Ÿè¡Œæ™‚é–“ãŠã‚ˆãåŠæ¸›ï¼ˆã‚‚ã¨ã‚‚ã¨7åˆ†48ç§’ã‹ã‹ã£ã¦ã„ãŸã®ãŒã€4åˆ†12ç§’ã«ãªã£ãŸã®ã§ã€åŽ³å¯†ã«ã¯46%å‰Šæ¸›ï¼‰

![ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œãƒ­ã‚°ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€‚4åˆ†12ç§’ã®è¡¨ç¤º](/images/jest-to-vitest/2025-10-28-06-11-10.png)

ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å®Ÿè¡Œæ™‚é–“å¤§å¹…æ¸›å°‘ã€‚

Jest 8.214s

![](/images/jest-to-vitest/2025-10-28-06-11-19.png)

Vitest 4.39s

![](/images/jest-to-vitest/2025-10-28-06-11-31.png)

ï¼ˆãƒ†ã‚¹ãƒˆæ•°é•ã£ã¡ã‚ƒã£ã¦ã‚‹ã‘ã©ã€ãƒ†ã‚¹ãƒˆæ•°å¤šã„ã®ã«æ—©ã„ã‚“ã ã‹ã‚‰ã™ã”ã„ï¼‰

### ãªã«ãŒå½±éŸ¿ã—ã¦ã„ã‚‹ã®ã‹

ä¸€ç•ªå®Ÿè¡Œæ™‚é–“ã«å½±éŸ¿ã—ãŸãƒã‚¤ãƒ³ãƒˆã¯ã€**å®Ÿè¡Œç’°å¢ƒã®åˆ†é›¢ã‚’ã‚ªãƒ•**ã«ã—ãŸã“ã¨ã§ã™ã€‚

- [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://vitest.dev/guide/improving-performance.html)ã«ã‚‚æ›¸ã„ã¦ã‚ã‚‹æ–¹æ³•ã€‚
- åŽ³å¯†ã«ã¯ã€isolateã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã¯ãªã `poolOptions.forks.singleForks` ã§è¨­å®šã—ã¦ã„ã‚‹
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒ†ã‚¹ãƒˆã§è¨­å®šã—ãŸå¤‰æ•°ç­‰ãŒä»–ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«æ¯Žå›žæ–°ã—ã„ç’°å¢ƒãŒä½œã‚‰ã‚Œã¾ã™ã€‚å‰¯ä½œç”¨ãŒç”Ÿã¾ã‚Œãªã„ä»£ã‚ã‚Šã«ã€å®Ÿè¡ŒãŒé…ããªã‚Šã¾ã™ã€‚
- ã“ã‚Œã‚’ã‚ªãƒ•ã«ã™ã‚‹ã“ã¨ã§å®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®ã—ã¦ã„ã¾ã™ãŒã€ãã®ã‹ã‚ã‚Šç’°å¢ƒå¤‰æ•°ã®ãƒªã‚»ãƒƒãƒˆãªã©ã¯è‡ªåˆ†ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ï¼ˆå®Ÿè¡Œæ™‚é–“ä»¥å¤–ã®ç‚¹ã§ï¼‰Vitest ã«ã™ã‚‹ã¨å¬‰ã—ã„ã“ã¨

- **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§¦ã‚‹ã¨ãã¯ã€ `npx vitest --standalone` ã‚’ä½¿ã†ã®ãŒä¾¿åˆ©ã€‚**
    - standalone ãƒ¢ãƒ¼ãƒ‰ã¯ã€ã‚³ãƒžãƒ³ãƒ‰å®Ÿè¡Œæ™‚ç‚¹ã§ã¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã›ã‚“ã€‚
    - ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ãŸã¨ãã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘å®Ÿè¡Œã—ã¾ã™ã€‚
    - ä¸€åº¦å¯¾è±¡ã«ãªã£ãŸå¾Œã¯ã€ãã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ä¿‚ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ãŸã¨ãã«è‡ªå‹•ã§å†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
- vitest ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§ã™
    - é–‹å§‹å¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ã¨ã€ãã‚Œã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒå†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
    - ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§ã¯ãªã1å›žã ã‘å®Ÿè¡Œã—ãŸã„å ´åˆã¯ `vitest run` ã‚³ãƒžãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™

## Jest ã‹ã‚‰ Vitest ã«å¤‰ãˆã‚‹ãŸã‚ã«ã‚„ã£ãŸã“ã¨

- `jest.*` ã¯ `vi.*` ã«å¤‰æ›´
    - ä¾‹ï¼š `jest.spyOn` â†’ `vi.spyOn`
    - `jest.Mocked` ã®ã¿ã€ `import type { Mocked } from 'vitest';` ãŒå¿…è¦
- Jest ã ã¨ã‚†ã‚‹ã‹ã£ãŸã‚¨ãƒ©ãƒ¼ã®æ¯”è¼ƒãŒåŽ³å¯†ã«ãªã‚Šã¾ã™ã€‚
    - ä¾‹ï¼š
        
        ```tsx
        // jestã ã¨ã€ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç•°ãªã£ã¦ã„ã¦ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã•ãˆä¸€è‡´ã—ã¦ã„ã‚Œã°ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ãŸ
        // vitest ã ã¨å¤±æ•—ã™ã‚‹
        await expect(
          (() => {
            throw new Error("ERROR_MESSAGE");
          })()
        ).rejects.toThrow(
          new HttpException("ERROR_MESSAGE", 400),
        );
        ```
        
- Jest ã ã¨ãªãœã‹ä»–ã®ãƒ†ã‚¹ãƒˆã«ã¾ã§æ®‹ã£ã¦ã„ãŸãƒ¢ãƒƒã‚¯ãŒã€Vitestã ã¨ã¡ã‚ƒã‚“ã¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™
    - Jest æ™‚ä»£ã«ã‚‚ afterEach ã§ restoreMock ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯å…¥ã£ã¦ã„ãŸã®ã§ã€æ„å›³ã—ãªã„ã‚‚ã®ã¨æ€ã‚ã‚Œã‚‹
    - ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã§å¿…è¦ãªãƒ¢ãƒƒã‚¯ã¯ `beforeEach` ã§æ›¸ãã¾ã—ã‚‡ã†ã€‚


## Vitest ç§»è¡Œæ™‚ã®æ ¼é—˜ãƒ­ã‚°

- `jest.*` ã¯ `vi.*` ã«ä¸€æ‹¬ã§å¤‰æ›´
    - `jest.Mocked` ã®ã¿ã€ `import type { Mocked } from 'vitest';` ãŒå¿…è¦
- ç’°å¢ƒå¤‰æ•°ãŒèª­ã¿è¾¼ã¾ã‚Œãªã„
    - `DB_URL=postgresql://${DB_USER}:${DB_PASSWORD}@...`  ã®ã‚ˆã†ãªä»–ã®ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã—ãŸç’°å¢ƒå¤‰æ•°ã§ã‚ã‚‹ãŸã‚ã€‚
    - dotenv-expandã‚’ä½¿ã£ã¦èª­ã¿è¾¼ã‚€ã€‚
        
        ```tsx
        dotenvExpand.expand(dotenv.config({ path: '.env.test' }));
        ```
        
- ZodError ã®æ¯”è¼ƒã«å¤±æ•—ã™ã‚‹
    - æ¯”è¼ƒä¸å¯èƒ½ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚åŽ³å¯†ã«æ¯”è¼ƒã—ã‚ˆã†ã¨ã—ã¦ã—ã¾ã†ãŸã‚ã€‚
    - ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ã‚¿ãƒ¼ã‚’å®šç¾©ã™ã‚‹
    - https://github.com/vitest-dev/vitest/issues/7315#issuecomment-2606572923
        
        ```tsx
        expect.addEqualityTesters([
          function (a, b) {
            const aOk = a instanceof z.ZodError;
            const bOk = b instanceof z.ZodError;
            if (aOk && bOk) {
              // or this.equals(a.message, b.message)
              return this.equals(a.issues, b.issues);
            }
            return aOk !== bOk ? false : undefined;
          },
        ]);
        ```
        
- `HttpException` ã®æ¯”è¼ƒã§å¤±æ•—ã™ã‚‹
    - ã“ã‚Œã‚‚ã€vitestãŒåŽ³å¯†ã«æ¯”è¼ƒã—ã‚ˆã†ã¨ã™ã‚‹ãŸã‚ã€‚
    - messageã¨statusã ã‘æ¯”è¼ƒã™ã‚‹ãƒ†ã‚¹ã‚¿ãƒ¼ã‚’å®šç¾©ã™ã‚‹
        
        ```tsx
          function httpExceptionEqualityTester(a, b) {
            if (a instanceof HttpException && b instanceof HttpException) {
              return a.message === b.message && a.getStatus() === b.getStatus();
            }
            return undefined;
          },
        ```
        
- jest ã§ã¯åŠ¹ã„ã¦ã„ãŸãƒ¢ãƒƒã‚¯ãŒåŠ¹ã‹ãªããªã‚‹
    - ãŸã ã—ã“ã‚Œã¯ã€jestãŒã‚¬ãƒãã¦ã€vitestã®æŒ™å‹•ãŒæ­£ã—ã„
    - jestã§ã¯describeã®ä¸­ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒƒã‚¯ãŒè¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã«æ®‹ã‚Šç¶šã‘ã‚‹ï¼ˆafterEach ã§ restoreMock ã‚’ã—ã¦ã„ãŸã¨ã—ã¦ã‚‚ï¼‰
    - vitest ã§ã¯ã“ã‚ŒãŒã¡ã‚ƒã‚“ã¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãŸã‚ã€jestã§å‹•ã„ã¦ã„ãŸãƒ†ã‚¹ãƒˆãŒå‹•ã‹ãªããªã‚‹ã¨ã„ã†äº‹è±¡ãŒèµ·ãã‚‹ã€‚
    - ãã®ãŸã‚beforeEachã§å®Ÿè¡Œã™ã‚‹ã€‚ã‚‚ã—ãã¯ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ã‚³ãƒ”ãƒšã—ã¦ã„ã
        
        ```tsx
        // Jestã§ã¯
        describe('è¦ªdescribe', () => {
          mockService.mockResolvedValue(null);
        
          it('test', () => {
            // mockServiceãŒundefinedã‚’è¿”ã™å¯èƒ½æ€§
        	});
          it('test', () => {
            // mockServiceãŒundefinedã‚’è¿”ã™å¯èƒ½æ€§
        	});
        });
        ```
        
        ```tsx
        // ä¿®æ­£
        describe('è¦ªdescribe', () => {
        	beforeEach(() => {
        	  mockService.mockResolvedValue(null);
          });
        
          it('test', () => {
            // 
        	});
          it('test', () => {
            // 
        	});
        });
        ```
        
- prisma ã® éƒ¨åˆ†çš„ãªãƒ¢ãƒƒã‚¯ãŒé©åˆ‡ã«restore ã•ã‚Œãªã„ï¼Ÿ
    - ã‚¨ãƒ©ãƒ¼æŒ™å‹•ã‚’è©¦ã™ãŸã‚ã®ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¢ãƒƒã‚¯ã‚’è¨­å®šã—ãŸå¾Œã€restoreMockã—ã¦ã‚‚ã‚‚ã¨ã«æˆ»ã£ã¦ã„ãªã‹ã£ãŸ
        
        ```tsx
        vi.spyOn(
          prismaService.getClient().userLearnedCourse,	
          'findMany',	
        ).mockImplementation(() => {	
          throw new Error();
        });
        ```
        
    - getClientè‡ªä½“ã‚’ãƒ¢ãƒƒã‚¯ã—ã¦å›žé¿
        
        ```tsx
        vi.spyOn(prismaService, 'getClient').mockImplementation(() => {
        	throw new Error();
        });
        ```
        
- ç©ºã®describeãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
    - .todo ã‚’ä½¿ã†
    
    ```tsx
      describe('hoge', () => {
        // å¾Œã§ä½œã‚‹
      });
    ```
    
    ```tsx
      describe.todo('hoge', () => {
        // å¾Œã§ä½œã‚‹
      });
    ```
    
- `'@faker-js/faker/.';` ãŒã‚¨ãƒ©ãƒ¼
    
    ```tsx
    import { faker } from '@faker-js/faker/.';
    ```
    
    ```tsx
    import { faker } from '@faker-js/faker';
    ```
    
- GraphQLFloat, GraphQLInt ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
    - åŒç­‰ã®å¤‰æ•°ã«ç½®ãæ›ãˆ
    
    ```tsx
    // GraphQLFloat, GraphQLInt ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
    vi.mock('graphql', async () => {
      const actual = await vi.importActual('graphql');
      return {
        ...actual,
        GraphQLFloat: Float,
        GraphQLInt: Int,
      };
    });
    ```
